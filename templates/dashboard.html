<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Windsurf Dashboard ‚Äì {{ current_view }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">üèÑ Windsurf Dashboard</div>
    <nav class="views">
      {% for v in views %}
        {% if v == current_view %}
          <span class="view active">{{ v }}</span>
        {% else %}
          <a class="view" href="/view/{{ v }}">{{ v }}</a>
        {% endif %}
      {% endfor %}
    </nav>
  </header>

  <main class="grid">
    {% if show_dwd %}
        <section class="card card--wide">
        <div class="card__title">DWD ‚Äì Gro√üwetterlage & Prognosen</div>
        <div class="card__content">
            <img id="dwd-rotator" class="frame dwd" alt="DWD Gro√üwetterlage" />
            <div class="muted" style="margin-top:.4rem">
            <small>Analysis shows for 30 s, then forecasts cycle every 5 s.</small>
            </div>
        </div>
        </section>

        <script>
        (function () {
            const version = "{{ dwd_version }}"; // daily cache-buster
            const frames = [
            { src: "/dwd/main.png?d=" + version,  duration: 30000 }, // 30s analysis
            { src: "/dwd/v036.png?d=" + version,  duration: 5000  },
            { src: "/dwd/v048.png?d=" + version,  duration: 5000  },
            { src: "/dwd/v060.png?d=" + version,  duration: 5000  },
            { src: "/dwd/v084.png?d=" + version,  duration: 5000  },
            { src: "/dwd/v108.png?d=" + version,  duration: 5000  },
            ];

            // Preload so switching is instant
            frames.forEach(f => { const img = new Image(); img.src = f.src; });

            const img = document.getElementById("dwd-rotator");
            let idx = 0;

            function show(i) {
            img.src = frames[i].src;
            img.dataset.idx = String(i);
            }

            function loop() {
            show(idx);
            const ms = frames[idx].duration;
            idx = (idx + 1) % frames.length;
            setTimeout(loop, ms);
            }

            show(0);
            setTimeout(loop, frames[0].duration);
        })();
        </script>
    {% endif %}

    <script>
        (function () {
            function applyFit() {
                const top = document.querySelector('.topbar')?.offsetHeight || 0;
                const foot = document.querySelector('.footer')?.offsetHeight || 0;
                // padding around main grid (matches .grid padding in CSS = .8rem ‚âà 12‚Äì13px)
                const padding = 16;
                const fitH = Math.max(320, window.innerHeight - top - foot - padding);
                document.documentElement.style.setProperty('--fit-h', fitH + 'px');
            }
            window.addEventListener('resize', applyFit);
            window.addEventListener('orientationchange', applyFit);
            // mobile Safari ‚Äú100vh‚Äù fix
            function setVhUnit() {
                document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
            }
            window.addEventListener('resize', setVhUnit);
            setVhUnit();
            applyFit();
        })();
    </script>


    {% for s in spot_cards %}
      <section class="card">
        <div class="card__title">{{ s.title }}</div>
        <div class="card__content">
          {% if s.iframe_src %}
            <iframe
              class="frame"
              src="{{ s.iframe_src }}"
              loading="lazy"
              referrerpolicy="no-referrer"
            ></iframe>
          {% else %}
            <div class="error">‚ö†Ô∏è Not configured correctly</div>
          {% endif %}
        </div>
      </section>
    {% endfor %}
  </main>

  <footer class="footer">
    <div>
      <small>
        Windy & Windfinder content ¬© their providers. Respect widget rules (Windfinder:
        ‚â§3 per page, no auto-refresh).
      </small>
    </div>
  </footer>

  {% if rotation_enabled and views|length > 1 %}
  <script>
    (function () {
      const views = {{ views|tojson }};
      const current = "{{ current_view }}";
      const intervalMs = {{ rotation_interval }} * 1000;

      let idx = views.indexOf(current);
      if (idx < 0) idx = 0;

      // Rotate by switching window.location to next /view/<name>.
      // NOTE: To comply with Windfinder ‚Äúno auto-refresh‚Äù, we can also implement
      // a mode that *does not* reload the page but toggles sections. For now we
      // rotate the whole view only if Windfinder is not present.
      const hasWindfinder = !!document.querySelector('iframe[src*="windfinder.com"]');

      if (!hasWindfinder) {
        setInterval(() => {
          idx = (idx + 1) % views.length;
          window.location.href = "/view/" + views[idx];
        }, intervalMs);
      } else {
        // Soft-rotate (no page reload): cycle visible cards every interval
        const cards = Array.from(document.querySelectorAll("main.grid > .card, .card--wide"));
        let visibleCount = Math.min(3, cards.length); // show first 3 by default
        let start = 0;

        function updateVisibility() {
          cards.forEach((c, i) => {
            const inWindow = i >= start && i < start + visibleCount;
            c.style.display = inWindow ? "" : "none";
          });
        }

        updateVisibility();
        setInterval(() => {
          start = (start + visibleCount) % cards.length;
          updateVisibility();
        }, intervalMs);
      }
    })();
  </script>
  {% endif %}
</body>
</html>
