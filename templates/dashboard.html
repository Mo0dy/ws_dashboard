<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Windsurf Dashboard ‚Äì {{ current_view }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css?v={{ dwd_version }}" />
</head>
<body>
  <header class="topbar">
    <div class="brand">üèÑ Windsurf Dashboard</div>
    <nav class="views">
      {% for v in views %}
        {% if v == current_view %}
          <span class="view active">{{ v }}</span>
        {% else %}
          <a class="view" href="/view/{{ v }}">{{ v }}</a>
        {% endif %}
      {% endfor %}
    </nav>
  </header>

  <!-- Use two-column only on compact (main); single-pane on detail -->
  <main class="{% if compact %}twocol{% else %}single{% endif %}">
    {% if compact and show_dwd %}
      <!-- LEFT: DWD only on compact (main) -->
      <section class="left">
        <div class="card card--dwd">
          <div class="card__title">DWD ‚Äì Gro√üwetterlage & Prognosen</div>
          <div class="card__content">
            <img id="dwd-rotator" class="dwd-img" alt="DWD Gro√üwetterlage" />
            <div class="muted" style="margin-top:.4rem">
              <small>Analysis 30 s, then forecasts 5 s each.</small>
            </div>
          </div>
        </div>
      </section>

      <script>
      (function () {
        const version = "{{ dwd_version }}";
        const frames = [
          { src: "/dwd/main.png?d=" + version,  duration: 30000 },
          { src: "/dwd/v36.png?d=" + version,  duration: 5000  },
          { src: "/dwd/036.png?d=" + version,  duration: 5000  },
          { src: "/dwd/048.png?d=" + version,  duration: 5000  },
          { src: "/dwd/060.png?d=" + version,  duration: 5000  },
          { src: "/dwd/084.png?d=" + version,  duration: 5000  },
          { src: "/dwd/108.png?d=" + version,  duration: 5000  },
        ];
        frames.forEach(f => { const im = new Image(); im.src = f.src; });
        const img = document.getElementById("dwd-rotator");
        let i = 0;
        let autoTimer = null;
        let userInteracting = false;
        
        function show() {
          img.src = frames[i].src;
          if (!userInteracting) {
            autoTimer = setTimeout(() => { 
              i = (i + 1) % frames.length; 
              show(); 
            }, frames[i].duration);
          }
        }
        
        function nextImage() {
          i = (i + 1) % frames.length;
          img.src = frames[i].src;
        }
        
        function stopAutoRotation() {
          if (autoTimer) {
            clearTimeout(autoTimer);
            autoTimer = null;
          }
          userInteracting = true;
        }
        
        function restartAutoRotation() {
          userInteracting = false;
          if (autoTimer) {
            clearTimeout(autoTimer);
          }
          autoTimer = setTimeout(() => { 
            i = (i + 1) % frames.length; 
            show(); 
          }, frames[i].duration);
        }
        
        // Add click/tap functionality
        img.addEventListener('click', function(e) {
          e.preventDefault();
          stopAutoRotation();
          nextImage();
          // Restart auto-rotation after 10 seconds of no interaction
          setTimeout(() => {
            if (userInteracting) {
              restartAutoRotation();
            }
          }, 10000);
        });
        
        // Make the image clickable by adding cursor pointer
        img.style.cursor = 'pointer';
        img.style.userSelect = 'none';
        
        // Start the automatic rotation
        show();
      })();
      </script>
    {% endif %}

    <!-- RIGHT (compact) or SINGLE (detail) -->
    <section class="{% if compact %}right{% else %}single-body{% endif %}">
      {% for s in spot_cards %}
        <div class="card {% if compact %}card--spot{% else %}card--map{% endif %}">
          <div class="card__title">
            {% if s.view_link %}
              <a href="{{ s.view_link }}" style="color: inherit; text-decoration: none;">{{ s.title }}</a>
            {% else %}
              {{ s.title }}
            {% endif %}
          </div>
          <div class="card__content">
            {% if s.iframe_src %}
              <iframe
                class="frame {% if compact %}spot-frame{% else %}map-embed{% endif %}"
                src="{{ s.iframe_src }}"
                loading="lazy"
                referrerpolicy="no-referrer"
              ></iframe>
              <!-- debug: {{ s.iframe_src }} -->
            {% else %}
              <div class="error">‚ö†Ô∏è Not configured correctly</div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </section>
  </main>

  <!-- Fit-to-viewport helpers (unchanged) -->
  <script>
    (function () {
      function applyFit() {
        const top = document.querySelector('.topbar')?.offsetHeight || 0;
        const foot = document.querySelector('.footer')?.offsetHeight || 0;
        const padding = 16;
        const fitH = Math.max(320, window.innerHeight - top - foot - padding);
        document.documentElement.style.setProperty('--fit-h', fitH + 'px');
      }
      window.addEventListener('resize', applyFit);
      window.addEventListener('orientationchange', applyFit);
      function setVhUnit() {
        document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
      }
      window.addEventListener('resize', setVhUnit);
      setVhUnit();
      applyFit();
    })();
  </script>

  <!-- Auto-scroll functionality for forecast widgets -->
  {% if compact and show_dwd %}
  <script>
    (function () {
      const rightContainer = document.querySelector('.twocol .right');
      if (!rightContainer) return;
      
      let autoScrollInterval;
      let autoScrollTimeout;
      let userInteracting = false;
      let currentCardIndex = 0;
      const cards = rightContainer.querySelectorAll('.card--spot');
      
      // Auto-scroll function
      function autoScroll() {
        if (userInteracting || cards.length === 0) return;
        
        currentCardIndex = (currentCardIndex + 1) % cards.length;
        const targetCard = cards[currentCardIndex];
        
        if (targetCard) {
          targetCard.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      }
      
      // Start auto-scroll
      function startAutoScroll() {
        const scrollInterval = cards.length > 0 ? Math.max(45000 / cards.length, 1000) : 45000; // Complete cycle in 45s, min 1s per card
        autoScrollInterval = setInterval(autoScroll, scrollInterval);
      }
      
      // Stop auto-scroll
      function stopAutoScroll() {
        clearInterval(autoScrollInterval);
        clearTimeout(autoScrollTimeout);
        autoScrollInterval = null;
        autoScrollTimeout = null;
      }
      
      // Reset auto-scroll timer
      function resetAutoScroll() {
        stopAutoScroll();
        userInteracting = false;
        autoScrollTimeout = setTimeout(() => {
          startAutoScroll();
        }, 60000); // Wait 60 seconds (1 minute) after user stops interacting
      }
      
      // Track user interaction
      function onUserInteraction() {
        userInteracting = true;
        stopAutoScroll();
        resetAutoScroll();
      }
      
      // Add event listeners for user interaction
      rightContainer.addEventListener('scroll', onUserInteraction);
      rightContainer.addEventListener('wheel', onUserInteraction);
      rightContainer.addEventListener('touchstart', onUserInteraction);
      rightContainer.addEventListener('touchmove', onUserInteraction);
      rightContainer.addEventListener('mousedown', onUserInteraction);
      
      // Start auto-scroll after initial delay
      setTimeout(() => {
        startAutoScroll();
      }, 3000); // Initial delay of 3 seconds
      
    })();
  </script>
  {% endif %}

  <footer class="footer">
    <div>
      <small>Windy & Windfinder content ¬© their providers.</small>
    </div>
  </footer>
</body>
</html>
