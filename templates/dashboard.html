<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Windsurf Dashboard ‚Äì {{ current_view }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css?v={{ dwd_version }}" />
</head>
<body>
  <header class="topbar">
    <div class="brand">üèÑ Windsurf Dashboard</div>
    <nav class="views">
      {% for v in views %}
        {% if v == current_view %}
          <span class="view active">{{ v }}</span>
        {% else %}
          <a class="view" href="/view/{{ v }}">{{ v }}</a>
        {% endif %}
      {% endfor %}
      {% if views %}
        <a class="view" href="/config" style="margin-left: auto;">‚öôÔ∏è Config</a>
      {% endif %}
    </nav>
  </header>

  <!-- Use two-column only on compact (main); single-pane on detail -->
  <main class="{% if compact %}twocol{% else %}single{% endif %}">
    {% if compact and show_dwd %}
      <!-- LEFT: DWD only on compact (main) -->
      <section class="left">
        <div class="card card--dwd">
          <div class="card__title">DWD ‚Äì Gro√üwetterlage & Prognosen</div>
          <div class="card__content">
            <img id="dwd-rotator" class="dwd-img" alt="DWD Gro√üwetterlage" />
            <div class="muted" style="margin-top:.4rem">
              <small>Analysis 30 s, then forecasts 5 s each.</small>
            </div>
          </div>
        </div>
      </section>

      <script>
      (function () {
        const version = "{{ dwd_version }}";
        const frames = [
          { src: "/dwd/main.png?d=" + version,  duration: 30000 },
          { src: "/dwd/v36.png?d=" + version,  duration: 5000  },
          { src: "/dwd/036.png?d=" + version,  duration: 5000  },
          { src: "/dwd/048.png?d=" + version,  duration: 5000  },
          { src: "/dwd/060.png?d=" + version,  duration: 5000  },
          { src: "/dwd/084.png?d=" + version,  duration: 5000  },
          { src: "/dwd/108.png?d=" + version,  duration: 5000  },
        ];
        frames.forEach(f => { const im = new Image(); im.src = f.src; });
        const img = document.getElementById("dwd-rotator");
        let i = 0;
        let autoTimer = null;
        let userInteracting = false;
        
        function show() {
          img.src = frames[i].src;
          if (!userInteracting) {
            autoTimer = setTimeout(() => { 
              i = (i + 1) % frames.length; 
              show(); 
            }, frames[i].duration);
          }
        }
        
        function nextImage() {
          i = (i + 1) % frames.length;
          img.src = frames[i].src;
        }
        
        function stopAutoRotation() {
          if (autoTimer) {
            clearTimeout(autoTimer);
            autoTimer = null;
          }
          userInteracting = true;
        }
        
        function restartAutoRotation() {
          userInteracting = false;
          if (autoTimer) {
            clearTimeout(autoTimer);
          }
          autoTimer = setTimeout(() => { 
            i = (i + 1) % frames.length; 
            show(); 
          }, frames[i].duration);
        }
        
        // Add click/tap functionality
        img.addEventListener('click', function(e) {
          e.preventDefault();
          stopAutoRotation();
          nextImage();
          // Restart auto-rotation after 10 seconds of no interaction
          setTimeout(() => {
            if (userInteracting) {
              restartAutoRotation();
            }
          }, 10000);
        });
        
        // Make the image clickable by adding cursor pointer
        img.style.cursor = 'pointer';
        img.style.userSelect = 'none';
        
        // Start the automatic rotation
        show();
      })();
      </script>
    {% endif %}

    <!-- RIGHT (compact) or SINGLE (detail) -->
    <section class="{% if compact %}right{% else %}single-body{% endif %}">
      {% for s in spot_cards %}
        <div class="card {% if compact %}card--spot{% else %}card--map{% endif %}">
          <div class="card__title">
            {% if s.view_link %}
              <a href="{{ s.view_link }}" style="color: inherit; text-decoration: none;" 
                 {% if s.description %}title="{{ s.description }}"{% endif %}>{{ s.title }}</a>
            {% else %}
              <span {% if s.description %}title="{{ s.description }}"{% endif %}>{{ s.title }}</span>
            {% endif %}
            <span class="wind-icon-container" data-directions="{{ s.wind_directions }}"></span>
          </div>
          <div class="card__content" style="position: relative;">
            {% if not compact %}
              <div class="spot-overlay wind-overlay-view" data-directions="{{ s.wind_directions }}"></div>
            {% endif %}
            {% if s.iframe_src %}
              <iframe
                class="frame {% if compact %}spot-frame{% else %}map-embed{% endif %}"
                src="{{ s.iframe_src }}"
                loading="lazy"
                referrerpolicy="no-referrer"
              ></iframe>
              <!-- debug: {{ s.iframe_src }} -->
            {% else %}
              <div class="error">‚ö†Ô∏è Not configured correctly</div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </section>
  </main>

  <!-- Fit-to-viewport helpers (unchanged) -->
  <script>
    (function () {
      function applyFit() {
        const top = document.querySelector('.topbar')?.offsetHeight || 0;
        const foot = document.querySelector('.footer')?.offsetHeight || 0;
        const padding = 16;
        const fitH = Math.max(320, window.innerHeight - top - foot - padding);
        document.documentElement.style.setProperty('--fit-h', fitH + 'px');
      }
      window.addEventListener('resize', applyFit);
      window.addEventListener('orientationchange', applyFit);
      function setVhUnit() {
        document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
      }
      window.addEventListener('resize', setVhUnit);
      setVhUnit();
      applyFit();
    })();
  </script>

  <!-- Wind direction icons -->
  <style>
    .wind-icon {
      display: inline-block;
      vertical-align: middle;
      color: var(--muted);
      margin-left: 0.5rem;
    }
    
    .spot-overlay {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      padding: 0.5rem;
      color: white;
    }
  </style>
  
  <script>
    // Generate a small wind direction icon SVG
    function createWindIcon(directions, size = 24) {
      const dirList = directions.split(',').map(d => d.trim()).filter(Boolean);
      if (dirList.length === 0) return '';
      
      const NS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(NS, "svg");
      svg.setAttribute("width", size);
      svg.setAttribute("height", size);
      svg.setAttribute("viewBox", "0 0 24 24");
      svg.setAttribute("class", "wind-icon");
      
      const cx = 12, cy = 12, r = 10;
      const dirMap = {
        'N': -90, 'NE': -45, 'E': 0, 'SE': 45,
        'S': 90, 'SW': 135, 'W': 180, 'NW': -135
      };
      
      // Background circle
      const circle = document.createElementNS(NS, "circle");
      circle.setAttribute("cx", cx);
      circle.setAttribute("cy", cy);
      circle.setAttribute("r", r);
      circle.setAttribute("fill", "none");
      circle.setAttribute("stroke", "currentColor");
      circle.setAttribute("stroke-width", "1");
      circle.setAttribute("opacity", "0.3");
      svg.appendChild(circle);
      
      // Draw filled sectors for selected directions
      dirList.forEach(dir => {
        if (dirMap[dir] !== undefined) {
          // Check if we're in compact mode (overview) vs single spot view
          const isOverview = document.querySelector('.twocol') !== null;
          const angleOffset = isOverview ? 180 : 0; // Add 180¬∞ for overview only
          const angle = (dirMap[dir] + angleOffset) * Math.PI / 180;
          const sectorAngle = 45 * Math.PI / 180; // 45 degree sectors
          const startAngle = angle - sectorAngle / 2;
          const endAngle = angle + sectorAngle / 2;
          
          // Create sector path
          const x1 = cx + r * Math.cos(startAngle);
          const y1 = cy + r * Math.sin(startAngle);
          const x2 = cx + r * Math.cos(endAngle);
          const y2 = cy + r * Math.sin(endAngle);
          
          const pathData = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 0 1 ${x2} ${y2} Z`;
          
          const sector = document.createElementNS(NS, "path");
          sector.setAttribute("d", pathData);
          sector.setAttribute("fill", "currentColor");
          sector.setAttribute("opacity", "0.6");
          sector.setAttribute("stroke", "currentColor");
          sector.setAttribute("stroke-width", "1");
          svg.appendChild(sector);
        }
      });
      
      return svg.outerHTML;
    }
  </script>

  <!-- Auto-scroll functionality for forecast widgets -->
  {% if compact and show_dwd %}
  <script>
    (function () {
      const rightContainer = document.querySelector('.twocol .right');
      if (!rightContainer) return;
      
      let autoScrollInterval;
      let autoScrollTimeout;
      let userInteracting = false;
      let currentCardIndex = 0;
      const cards = rightContainer.querySelectorAll('.card--spot');
      
      // Auto-scroll function
      function autoScroll() {
        if (userInteracting || cards.length === 0) return;
        
        currentCardIndex = (currentCardIndex + 1) % cards.length;
        const targetCard = cards[currentCardIndex];
        
        if (targetCard) {
          targetCard.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      }
      
      // Start auto-scroll
      function startAutoScroll() {
        const scrollInterval = cards.length > 0 ? Math.max(45000 / cards.length, 1000) : 45000; // Complete cycle in 45s, min 1s per card
        autoScrollInterval = setInterval(autoScroll, scrollInterval);
      }
      
      // Stop auto-scroll
      function stopAutoScroll() {
        clearInterval(autoScrollInterval);
        clearTimeout(autoScrollTimeout);
        autoScrollInterval = null;
        autoScrollTimeout = null;
      }
      
      // Reset auto-scroll timer
      function resetAutoScroll() {
        stopAutoScroll();
        userInteracting = false;
        autoScrollTimeout = setTimeout(() => {
          startAutoScroll();
        }, 60000); // Wait 60 seconds (1 minute) after user stops interacting
      }
      
      // Track user interaction
      function onUserInteraction() {
        userInteracting = true;
        stopAutoScroll();
        resetAutoScroll();
      }
      
      // Add event listeners for user interaction
      rightContainer.addEventListener('scroll', onUserInteraction);
      rightContainer.addEventListener('wheel', onUserInteraction);
      rightContainer.addEventListener('touchstart', onUserInteraction);
      rightContainer.addEventListener('touchmove', onUserInteraction);
      rightContainer.addEventListener('mousedown', onUserInteraction);
      
      // Start auto-scroll after initial delay
      setTimeout(() => {
        startAutoScroll();
      }, 3000); // Initial delay of 3 seconds
      
    })();
  </script>
  {% endif %}

  <script>
    // Initialize wind direction icons
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize icons in card titles
      document.querySelectorAll('.wind-icon-container').forEach(container => {
        const directions = container.dataset.directions;
        if (directions && directions !== 'N,NE,E,SE,S,SW,W,NW') {
          container.innerHTML = createWindIcon(directions, 18);
        }
      });
      
      // Initialize overlay icons for individual spot views
      document.querySelectorAll('.wind-overlay-view').forEach(overlay => {
        const directions = overlay.dataset.directions;
        if (directions && directions !== 'N,NE,E,SE,S,SW,W,NW') {
          overlay.innerHTML = createWindIcon(directions, 32);
        }
      });
    });
  </script>

  <footer class="footer">
    <div>
      <small>Windy & Windfinder content ¬© their providers.</small>
    </div>
  </footer>
</body>
</html>
